name: Release

on:
  push:
    branches: ["dev"]

permissions:
  contents: write
  security-events: write

concurrency:
  group: release-main
  cancel-in-progress: false

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: sample-nodejs
      REGISTRY: docker.io

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Tests
        run: npm test --if-present

      - name: Semgrep gate (fail on findings)
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/owasp-top-ten
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Decide bump (major/minor/patch)
        id: bump
        run: |
          set -euo pipefail
          LAST_TAG="$(git describe --tags --abbrev=0 2>/dev/null || echo '')"
          if [ -n "$LAST_TAG" ]; then
            RANGE="$LAST_TAG..HEAD"
          else
            RANGE="HEAD"
          fi

          LOG="$(git log --format=%B $RANGE)"

          echo "$LOG" | grep -qi "BREAKING CHANGE" && { echo "type=major" >> $GITHUB_OUTPUT; exit 0; }
          echo "$LOG" | grep -qiE "^feat(\(|:)" && { echo "type=minor" >> $GITHUB_OUTPUT; exit 0; }
          echo "type=patch" >> $GITHUB_OUTPUT

      - name: Bump npm version (updates package.json + lock)
        run: |
          set -euo pipefail
          npm version ${{ steps.bump.outputs.type }} --no-git-tag-version
          echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build locally (load) for scanning
      - name: Build image (local for scan)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.VERSION }}
          provenance: false

      - name: Trivy scan (fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ env.VERSION }}
          format: table
          exit-code: "1"
          ignore-unfixed: true
          severity: "HIGH,CRITICAL"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Push only after scan passes
      - name: Build & Push image (version + latest)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
            ${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          provenance: false

      - name: Update Helm chart version + image tag
        run: |
          set -euo pipefail

          # Chart.yaml: version + appVersion
          sed -i "s/^version: .*/version: ${VERSION}/" charts/sample-nodejs/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: \"${VERSION}\"/" charts/sample-nodejs/Chart.yaml

          # values.yaml: image.repository + tag
          sed -i "s|^  repository:.*|  repository: ${REGISTRY}/${{ secrets.DOCKERHUB_USERNAME }}/${IMAGE_NAME}|" charts/sample-nodejs/values.yaml
          sed -i "s|^  tag:.*|  tag: ${VERSION}|" charts/sample-nodejs/values.yaml

      - name: Commit, tag, push (ArgoCD GitOps trigger)
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json package-lock.json charts/sample-nodejs/Chart.yaml charts/sample-nodejs/values.yaml
          git commit -m "chore(release): v${VERSION}"
          git tag "v${VERSION}"
          git push origin main --tags

