name: Release

on:
  push:
    branches: ["dev"]   

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    env:
      APP_NAME: sample-nodejs
      CHART_DIR: charts/sample-nodejs

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Tests
        run: npm test --if-present

      - name: Semgrep (SAST) gate - fail on HIGH/CRITICAL
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/owasp-top-ten
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Decide bump (major/minor/patch)
        id: bump
        shell: bash
        run: |
          set -euo pipefail
          LAST_TAG="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          if [ -n "${LAST_TAG}" ]; then
            RANGE="${LAST_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi

          LOG="$(git log --format=%B ${RANGE})"

          if echo "$LOG" | grep -qi "BREAKING CHANGE"; then
            echo "type=major" >> "$GITHUB_OUTPUT"
          elif echo "$LOG" | grep -qiE "^feat(\(|:)" ; then
            echo "type=minor" >> "$GITHUB_OUTPUT"
          else
            echo "type=patch" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump npm version (not committed yet)
        shell: bash
        run: |
          set -euo pipefail
          npm version "${{ steps.bump.outputs.type }}" --no-git-tag-version
          echo "VERSION=$(node -p "require('./package.json').version")" >> "$GITHUB_ENV"

      - name: Compute IMAGE_REPO (sanitize + validate)
        shell: bash
        run: |
          set -euo pipefail

          RAW="${{ secrets.DOCKERHUB_USERNAME }}"
          USERNAME="$(echo -n "$RAW" | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')"

          if [ -z "$USERNAME" ]; then
            echo "DOCKERHUB_USERNAME secret is empty or not set."
            exit 1
          fi

          # Docker Hub username validation
          if echo "$USERNAME" | grep -q '@'; then
            echo "DOCKERHUB_USERNAME looks like an email. Use the Docker Hub *username* (no @)."
            exit 1
          fi

          if ! echo "$USERNAME" | grep -Eq '^[a-z0-9][a-z0-9_-]{0,29}$'; then
            echo "DOCKERHUB_USERNAME has invalid characters. Use only lowercase letters, digits, _ or - (max 30 chars)."
            exit 1
          fi

          echo "IMAGE_REPO=${USERNAME}/${APP_NAME}" >> "$GITHUB_ENV"
          echo "Using IMAGE_REPO=${USERNAME}/${APP_NAME}"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (local for scan)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: |
            ${{ env.IMAGE_REPO }}:${{ env.VERSION }}
          provenance: false

      - name: Trivy scan (fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.IMAGE_REPO }}:${{ env.VERSION }}
          format: table
          exit-code: "1"
          ignore-unfixed: true
          severity: "HIGH,CRITICAL"

      - name: Build & Push image (version + latest)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:${{ env.VERSION }}
            ${{ env.IMAGE_REPO }}:latest
          provenance: false
      - name: Update Helm chart versions + image values
        shell: bash
        run: |
          set -euo pipefail

          # Chart.yaml: version + appVersion
          sed -i "s/^version: .*/version: ${VERSION}/" "${CHART_DIR}/Chart.yaml"
          sed -i "s/^appVersion: .*/appVersion: \"${VERSION}\"/" "${CHART_DIR}/Chart.yaml"

          # values.yaml: image.repository + tag
          sed -i "s|^  repository:.*|  repository: ${IMAGE_REPO}|" "${CHART_DIR}/values.yaml"
          sed -i "s|^  tag:.*|  tag: ${VERSION}|" "${CHART_DIR}/values.yaml"

      - name: Commit, tag, push (GitOps trigger)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json package-lock.json "${CHART_DIR}/Chart.yaml" "${CHART_DIR}/values.yaml"
          git commit -m "chore(release): v${VERSION}"
          git tag "v${VERSION}"
          git push origin "${GITHUB_REF_NAME}" --tags

